fileVersion: 1
id: fedc5a29-eac3-4eda-8d20-1dbc8cf440ec
name: LOAD_D_RAW_MAT_HLTH_PRICE_MEASURES_2
operation:
  config:
    SQL_Code: |-
      BEGIN 

      INSERT INTO {{ ref('E_SC_MP', 'D_RAW_MAT_HLTH_PRICE_MEASURES') }}
      WITH BASE_CTE AS (
      	SELECT DISTINCT
      		F.SUBCON_PART_NO
      		,MEDIAN(F.CLAIM_UNIT_PRICE) AS UNIT_PRICE
      		,ltrim(CAST(F.VENDOR_CODE AS VARCHAR),0) AS VENDOR_LOCATION
      	
      	FROM 
      		ENG_WW_MEM_DM.MEM_APPS.MATERIAL_CLAIM_REQUEST F
      		WHERE REGEXP_LIKE(VENDOR_CODE, '[0-9]+')
              GROUP BY
      	SUBCON_PART_NO
      	,VENDOR_LOCATION
      ORDER BY SUBCON_PART_NO
      ),
      			
      XREF_MEASURES AS (
      SELECT * FROM {{ ref('E_SC_MP', 'F_XREF_MEASURES') }} WHERE SAP_MATERIAL_NO LIKE '3%' ORDER BY VENDOR_PART_NO
      ),

      BRING_MATNO AS (
      SELECT UNIT_PRICE,VENDOR_LOCATION,XREF.SAP_MATERIAL_NO AS MATERIAL_NUMBER FROM BASE_CTE 
      INNER JOIN XREF_MEASURES XREF ON BASE_CTE.SUBCON_PART_NO=XREF.VENDOR_PART_NO ORDER BY VENDOR_LOCATION
      ),

      BRING_PLANT AS (
      select UNIT_PRICE,BM.VENDOR_LOCATION,MATERIAL_NUMBER,FS.SAP_LOCATION AS PLANT FROM BRING_MATNO BM LEFT OUTER JOIN {{ ref('E_SC_MP', 'F_SUBCON_PLANT_MAP') }} FS ON BM.VENDOR_LOCATION=FS.VENDOR_LOCATION ORDER BY MATERIAL_NUMBER
      ),

      D_MATERIAL AS (
      SELECT DISTINCT MATERIAL_NUMBER,CAST(MATERIAL_GROUP AS NVARCHAR(20)) AS MATERIAL_GROUP 
      FROM {{ ref('E_MASTER_DATA_MD', 'V_D_MATERIAL') }}
      WHERE MATERIAL_NUMBER LIKE '3%' ORDER BY MATERIAL_NUMBER
      ),


      BRING_MATGRP_FINAL AS (
      select UNIT_PRICE,VENDOR_LOCATION,BP.MATERIAL_NUMBER,IFF(PLANT = 'SG31','TSMT',PLANT) AS PLANT,DM.MATERIAL_GROUP,CAST(CURRENT_TIMESTAMP AS TIMESTAMP) AS "EDW_CREATE_DATE",
        CAST(CURRENT_TIMESTAMP AS TIMESTAMP) AS "EDW_UPDATE_DATE",
        0 AS "EDW_CYCLE_ID"  FROM BRING_PLANT BP LEFT OUTER JOIN D_MATERIAL DM ON BP.MATERIAL_NUMBER=DM.MATERIAL_NUMBER
      )



      SELECT 
      MATERIAL_NUMBER,
      MATERIAL_GROUP,
      NULL AS MATERIAL_DESCRIPTION,
      PLANT,
      NULL AS LAST_CHANGE_DATE,
      NULL AS MATERIAL_TYPE,
      NULL AS UNIT_OF_MEASURE,
      NULL AS PURCHASING_GROUP,
      NULL AS ABC_KEY,
      NULL AS MRP_TYPE,
      NULL AS STANDARD_PRICE_USD,
      NULL AS STANDARD_PRICE,
      NULL AS PRICE_UNIT,
      NULL AS LEAD_TIME,
      NULL AS CURRENCY_KEY,
      UNIT_PRICE AS UNIT_PRICE,
      EDW_CREATE_DATE AS EDW_CREATE_DATE,
      EDW_UPDATE_DATE AS EDW_UPDATE_DATE,
      EDW_CYCLE_ID AS EDW_CYCLE_ID
      FROM 
      BRING_MATGRP_FINAL;


      END 
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: E_SC_TEMP
  materializationType: sql
  metadata:
    appliedNodeTests: []
    columns: []
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          D_RAW_MAT_HLTH_PRICE_MEASURES: e44e0485-2796-4292-bbf0-61e2a0ce8861
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: E_SC_MP
            nodeName: D_RAW_MAT_HLTH_PRICE_MEASURES
        join:
          joinCondition: FROM {{ ref('E_SC_MP', 'D_RAW_MAT_HLTH_PRICE_MEASURES') }} "D_RAW_MAT_HLTH_PRICE_MEASURES"
        name: LOAD_D_RAW_MAT_HLTH_PRICE_MEASURES_2
        noLinkRefs: []
  name: LOAD_D_RAW_MAT_HLTH_PRICE_MEASURES_2
  overrideSQL: false
  schema: ""
  sqlType: "187"
  type: sql
  version: 1
type: Node
