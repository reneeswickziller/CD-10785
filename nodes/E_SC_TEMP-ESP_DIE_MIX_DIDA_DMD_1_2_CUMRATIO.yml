fileVersion: 1
id: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
name: ESP_DIE_MIX_DIDA_DMD_1_2_CUMRATIO
operation:
  config:
    insertStrategy: INSERT
    postSQL: |-
      delete from {{ ref('E_SC_TEMP', 'ESP_DIE_MIX_DIDA_DMD_1_2_CUMRATIO')}}

      where  1= CASE WHEN '{{parameters.SCENARIO_NAME}}'='ALL' THEN 1
                 WHEN SCENARIO_NAME='{{parameters.SCENARIO_NAME}}' THEN 1
                 ELSE 0 END

      and "LOADDATETIMESTAMP" <=(SELECT WATER_MARKER_TIMESTAMP FROM {{ ref('E_SC_UTIL_USER','LOAD_CONTROL_SC_SPO') }}

                                WHERE PROCEDURE_NAME = 'BV_ESP_DIE_MIX_DIDA_INSERT'  and  SCENARIO_NAME='{{parameters.SCENARIO_NAME}}' )
    preSQL: |
      delete from {{ ref('E_SC_TEMP', 'ESP_DIE_MIX_DIDA_DMD_1_2_CUMRATIO')}}
      where (SCENARIO_DATE,SCENARIO_NAME) IN (SELECT SCENARIO_DATE,SCENARIO_NAME FROM {{ ref('E_SC_TEMP', 'ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY') }}
                                              where 1= CASE WHEN '{{parameters.SCENARIO_NAME}}'='ALL' THEN 1
                                                         WHEN SCENARIO_NAME='{{parameters.SCENARIO_NAME}}' THEN 1
                                                         ELSE 0 END 
                                              GROUP BY SCENARIO_DATE,SCENARIO_NAME           
                                              );
    testsEnabled: true
    truncateBefore: true
  database: ""
  deployEnabled: true
  description: ""
  isMultisource: false
  locationName: E_SC_TEMP
  materializationType: table
  metadata:
    appliedNodeTests: []
    columns:
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 1aabaa2a-5bce-4653-ae01-d241306474e1
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: DATE
        description: ""
        hashDetails: null
        name: SCENARIO_DATE
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: fd09318f-38b7-4ef1-b825-a0f10b53e472
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0da80c03-9529-46b4-a72f-3a5e326510a9
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(50)
        description: ""
        hashDetails: null
        name: SCENARIO_NAME
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: cdc669c4-a773-4115-8cb7-dd8dc78dcb0d
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 26cca5ec-2b3e-42c1-a884-45de1e7c2743
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(30)
        description: ""
        hashDetails: null
        name: DMD_MPN
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: c0f8aa1c-98ec-45bc-b935-9d03e6a337ab
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 76babf6f-a65d-4544-8a71-57f9e0537aad
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(18)
        description: ""
        hashDetails: null
        name: DMD_FGPN
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 646edc7b-c3f2-4bc4-993c-d91aef51c598
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 41370954-eeb0-44c7-849d-fac863ba16e9
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(30)
        description: ""
        hashDetails: null
        name: DMD_PCG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 84821676-0e71-4205-a65d-d60061a9c011
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 3773e86d-b756-4bf0-a041-f74658d54fea
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(18)
        description: ""
        hashDetails: null
        name: SUPPLY_FGPN
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 63a5a209-0621-4e63-8ea1-ff3cd9e4a1bc
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8da3e757-9e9d-4d1b-929e-76945367d7da
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(30)
        description: ""
        hashDetails: null
        name: SUPPLY_DID
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 4ab7d40d-aa19-49ff-8270-8cca95d6d913
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 22fe9ce7-95cf-48cd-b14a-7265b7b22618
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(30)
        description: ""
        hashDetails: null
        name: SUPPLY_PCG
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2f3861bb-2879-4483-8c07-20ea296464ed
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 738c77cc-2e12-4192-b0a9-fc784bf10c61
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: TIMESTAMP_NTZ(9)
        description: ""
        hashDetails: null
        name: LOADDATETIMESTAMP
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 035effaa-997a-4e6c-9753-966838052acd
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: dc61ef6c-7d6d-4a9e-8aaf-c767319d59f7
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(128)
        description: ""
        hashDetails: null
        name: ENTBOM_TOAD
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 31694684-a47d-458d-a7ad-6c776d6e1c99
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 5c634a8d-77c4-4bad-a1f6-a32e28199915
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(6)
        description: ""
        hashDetails: null
        name: FISCAL_MONTH_NAME
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: ba456b02-0eb1-4350-b405-544dd8ee9967
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 8c76de28-5ac2-40c9-99b4-f4a8b81ebb09
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: VARCHAR(6)
        description: ""
        hashDetails: null
        name: FISCAL_PERIOD_SORT
        nullable: false
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 0e7dad6c-635e-40b0-9617-a312a8f5c994
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: 0af48ef6-39e3-4e86-a22e-80299a0b9c66
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        description: ""
        hashDetails: null
        name: DID_DMDQTY_MTH
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: 2bfc9fb1-93ab-476b-8732-1e37c51269b2
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: fe1f8550-e059-4a70-b31e-92e35a83097c
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        description: ""
        hashDetails: null
        name: CUM_MONTHLY_DMD_QTY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: bd761c97-229d-48b1-bcb8-dc6aa9355abe
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: b6fe0635-3f16-421c-ba51-bc8f67a3d4c3
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        description: ""
        hashDetails: null
        name: MONTHLY_TOTAL_DMD_QTY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: f5e233a0-f3e7-4270-92dd-5d16d170e8ae
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - appliedColumnTests: {}
        columnReference:
          columnCounter: ca438591-0907-4275-896f-9ce61792ff24
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        description: ""
        hashDetails: null
        name: CUM_MONTHLY_TOTAL_DMD_QTY
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: dd5960cc-43f3-48c7-ac00-ee88020932a9
                stepCounter: 27f15f5e-d55a-4536-ac56-f71031e7f413
            transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: b4c55ce8-1f6a-440e-a3f0-a3d8b43089b4
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        defaultValue: ""
        description: ""
        name: ALLOCATION_RATIO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."MONTHLY_TOTAL_DMD_QTY" IS NULL THEN 0 
              WHEN "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."DID_DMDQTY_MTH" IS NULL THEN 0 
                        ELSE CAST(substr(("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."DID_DMDQTY_MTH"  /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."MONTHLY_TOTAL_DMD_QTY"),1,charindex('.',("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."DID_DMDQTY_MTH"  /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."MONTHLY_TOTAL_DMD_QTY"))+6) AS DECIMAL(34,6))
                   END 
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 972765fe-aaa0-4025-a477-000d01c0f04d
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        defaultValue: ""
        description: ""
        name: CUM_ALLOCATION_RATIO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              CASE WHEN "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY" IS NULL THEN 0 
                       ELSE CAST(substr(("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_DMD_QTY" /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY"),1,charindex('.',("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_DMD_QTY"  /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY"))+6) AS DECIMAL(34,6))
                   END
        transform: ""
      - acceptedValues:
          strictMatch: true
          values: []
        appliedColumnTests: {}
        columnReference:
          columnCounter: 7bd03e62-0260-46e1-9693-1c4049774142
          stepCounter: 2d98af8b-16ea-4ee6-a99d-e7ee09c04d75
        config: {}
        dataType: NUMBER(34,6)
        defaultValue: ""
        description: ""
        name: NET_ALLOCATION_RATIO
        nullable: true
        sourceColumnReferences:
          - columnReferences:
              - columnCounter: "0"
                stepCounter: "0"
            transform: |-
              SUM(CASE WHEN ("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."SCENARIO_DATE","ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."FISCAL_PERIOD_SORT") IN(SELECT "SCENARIO_DATE",MAX(FISCAL_PERIOD_SORT) FROM {{ ref('E_SC_TEMP', 'ESP_DIE_MIX_DIDA_SCAFFOLD_DMD_1_2') }} GROUP BY "SCENARIO_DATE") 
              	         THEN CASE WHEN "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY" IS NULL THEN 0 
              	               ELSE CAST(substr(("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_DMD_QTY" /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY"),1,charindex('.',("ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_DMD_QTY"  /"ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."CUM_MONTHLY_TOTAL_DMD_QTY"))+6) AS DECIMAL(34,6)) 
              	               END 
              	      ELSE 0 
              	      END) OVER(PARTITION BY "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."SCENARIO_DATE","ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."SCENARIO_NAME","ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."DMD_FGPN","ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."SUPPLY_FGPN")
        transform: ""
    cteString: ""
    enabledColumnTestIDs: []
    sourceMapping:
      - aliases:
          ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY: 27f15f5e-d55a-4536-ac56-f71031e7f413
        customSQL:
          customSQL: ""
        dependencies:
          - locationName: E_SC_TEMP
            nodeName: ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY
          - locationName: E_SC_TEMP
            nodeName: ESP_DIE_MIX_DIDA_SCAFFOLD_DMD_1_2
        join:
          joinCondition: |-
            FROM {{ ref('E_SC_TEMP', 'ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY') }} "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"
            WHERE 1 = CASE WHEN '{{parameters.SCENARIO_NAME}}'='ALL' THEN 1
                           WHEN "ESP_DIE_MIX_DIDA_DMD_1_2_CUMQTY"."SCENARIO_NAME"='{{parameters.SCENARIO_NAME}}' THEN 1
                           ELSE 0 END
        name: ESP_DIE_MIX_DIDA_DMD_1_2_CUMRATIO
        noLinkRefs: []
  name: ESP_DIE_MIX_DIDA_DMD_1_2_CUMRATIO
  overrideSQL: false
  schema: ""
  sqlType: persistentStage
  type: sql
  version: 1
type: Node
